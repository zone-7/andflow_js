/*!
 * andflow.js v1.0.0
 * @url https://github.com/zone-7/andflow_js
 * @date 2021-11-17
 * @author zone-7
 * @email 502782757@qq.com
 *
 * Released under the MIT License
 *
 */
var andflow={containerId:null,img_path:"",editable:!0,tags:null,metadata:null,flowModel:null,show_toolbar:!0,show_grid:!0,metadata_style:"",metadata_position:"",drag_step:10,render_action:null,render_action_helper:null,render_link:null,render_endpoint:null,render_btn_resize:null,render_btn_remove:null,event_action_click:null,event_action_dblclick:null,event_action_remove:null,event_group_click:null,event_group_dblclick:null,event_group_remove:null,event_link_click:null,event_link_dblclick:null,event_link_remove:null,event_canvas_click:null,event_canvas_changed:null,animation_timer:null,lang:{metadata_tag_all:"所有组件",delete_action_confirm:"确定删除该节点?"},_themeObj:null,_plumb:null,_actionInfos:{},_actionScript:{},_actionCharts:{},_action_states:[],_actionContents:{},_linkInfos:{},_link_states:[],_groupInfos:{},_listInfos:{},_tipInfos:{},_timer_link:null,_timer_group:null,_timer_action:null,_timer_thumbnail:null,_drag_name:null,_icon_nav:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAHJJREFUWEftlkEKgDAMBNOfKeRj/muhPk1yEbVaFCm5TO/tDAMlKZZ8SjLfEKAABW4LuHs1s2nEF5V0YvYEgr9cJEJs/iFWPwlI2mHuHkWaB97KPN3vFkCAAhSgAAUokF0gdR8YAo/RLWk9jnB2QgpQYAN8cboh/l0GAAAAAABJRU5ErkJggg==",_icon_eye:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAjNJREFUWEft1kuoT1EUx/HPzWuiPCZiTCEhlDwmBsiACUKiJAxMiBEDDK6Rx0Apj7yTRwYmihQDQogMPEtGlAkGJK+0ah8du///nnP/Ayd1V51OZ++z1/ru31577d2lYetqOL4+gP9egfH4heed5lJvFViPmZiQnkEp8Fc8xlPcw+G6QHUBInA8U2s6fpggKkGqAGbgQCnwWxzBG7zCi7QEYzAa8V6HUQk0QDbhVjvwngAW4yiGogh8CO8qVBiJDSWQT+n7fKtx7QCCen8acBdrWiTaREzBd9zHyyzAWJzA9NS+BftyiFYAy3Au/XgVq/G+NHApNiOWp2wXE/SdUuMInMbc1LYcfymRAwzEbUzDZSzBj5LDVTiVvq+lHOiH2QhFwibhSWnMAFzCQjzALHwr+nOAbehOnTHDkL+wCHADw7ELO0t90XYcixBg8zN15iHUDNuO3a0AxqXZD8NebM2crMBZPEoz/pL1x8yKbA8FYweU7QxW4kNS4Vl0lhWIGe1IIwbjc+YgkmgPjmFt1ld8XsGClPV5DRiCj+nHPwr2BqDYGQexsQ3ABUSSxq6JHVC2SoCqJQjHEaDOEuSJGCCVSxA/9ZSEk1MSRmHKkzDaTqYkvIk5nSRhjKnahnEeRDUMu47X6J8KUgCG5QnYq20YDhotRIVydUpxnIzx/ERUvziKy9ZxKS6cNHoYFRCNHsdlORu7kOT1prErWZvC559fStuBdNxedSfs2HHdgX0AjSvwG5F4nCH6feA0AAAAAElFTkSuQmCC",_icon_eye_close:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAspJREFUWEft1kvoVVUUx/HPHwmCwBrkwHz0Es3EF2I0CQoEwVdOfIyUQs03DoQUlYp8gA4ExYRKJBv4GulARRDDB6IYRBYqJVqaOBBf+AhEkCX7yOl0zr3n/v/8+TtwTS7su/Za3/3ba6192nSxtXVxfs8sQH/cx5XOVqhKgVMYicnY3ZkQVQBf4ouUuAxiGAbiNdzDOfyBf1qFbVQDjSAu4o2SZMexF3twvg5MsyKsgoj1zLqjN97B4Nz6WqzD9UYgzQDexS4ManAd+fhDMREZYKiwCj9WQTQCiOS/p41RiJNqQoTbGKxGAIV9lYP6D0sVwIc4nDw/xdakRCsQryaImSlO/H5fVKIMIJ98LPblNsV1tAIRW9dgSYrxFqKAn1oRYAj2p/aqkq09EN9gDg5hVCOA7ZiKLZhRUTj5zgiXusMqix3d8XkWO69AJA6nh+iLayUAL+NWOwuzH37BS/gIP0WcPEAUXdz/LHxXcfro819xFb3aUZgLsCENq4+LAJswN83+kLXMsta8gDhRWCs1cQLvYyMWFgHeRjj0wHRsKyF4EZE83oCnMtaEWI6vk3ojsisudkEm0R2Mx5ESiNnYnNYvo1sCyrsWC3M4jqb7z+bKE/+yObADU3A2tUzcd9FiFoT0eZuHN7E4LeYh4mWN7jmGD/Kbqibh3+iDg6ktb5ZAvJJexEcI/9vJ5wdMK4GIAj+Nu3UAwife9yi0M1hZcuKKOn2yfACjSyD+t6fZa5iv8JjjAfJXo8zoic8Qsz+KNaxyWDUDiM2RdFkKdCON6hjX8fFxKa2/kJ7seIrziWOcN/qyqv1VPA4r8F7h9NGSDzAAAZHZt1iKAJ6f+r5UiToK5HNGIU1IMyA+UrKkkegkfsNO/FwAXYT1aS06JVOutgJl1x7J4+T/4s8mdRF/Rxu+jk/qdkGNmB13afUKOp6xEOE5QJcr8BhVNZUhAZa4eAAAAABJRU5ErkJggg==",_icon_cursor_hand:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAfJJREFUWEft1r+rz1Ecx/HHLdNdlGK4g1gw3IHUNRgw2GxSBuqSDErcJIv8GCySDAqDRUnXaiJhUTJQymJScv+A272Tgd51jo6P637P53z79o186vSp8/mc9/t5Xud93u/3hDE/E2P2768H2IRv+Nqq5DAKvMGu5PghjrRA9AWYxSS24XRy+Ap7E8B6vMCHWpg+AI9xqGM41ofzl535C7heA1ELcAWX8QhrCpASYBl3cRARG1cRc6HG0z/B1ALEDmOn+xCSf08GS4CYj+8ZtvQZMDH/2zNKgHC6FmexgK1Y6hKMGiB2nRXJ6v3C8E8ARMC9xjMcK3acz30oBU5iCns6Qfg26TizQlxFsMaIoIzRDHAfxzsO8jluSfOfKu56E0Ck2Ei1T9LdPt9RoMLvz1+aAM7hRkomYaCbB0YOcCDt/jn2p7QaaTiO4HMf760xEOn2PaaxE+96Oi1/bzqCMJCPYR6HxwGwLqmwEZsbpM/MzQqEgUgml3AHpxpVGAogdh6xEEUlxmIDRJTiHdjQWg1v4Qyu4WJPgAc4ittFB9W7GG1PKnzEiZSgajjyVf6C3Yh3cz9QtmO58RgEkW9R9I6hwIpPbTmOxVGY7iUrNetWDb5MU2OoJC9bsUEK/AeYw82ikR06BgZJ3vS9bww0OVlt0Q8nvokhubPnZQAAAABJRU5ErkJggg==",_icon_cursor_auto:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAlZJREFUWEfV10vITWEUxvHfN1IkmRhgIERSiiRKuUwkjMhIbgMmQkpMhFIYuSdKiEgiyTXFRy7lOpOBXDKiyIARoaW1azvOOd85Ovsrq87ofc/7/Pd617P22l2YjiVYqrrYjdu4UCvRhS2YlhuqQpiLb5hSD+AntiZIVQDxkJsxA91lkcjAfwUwAu/xpc1UdSwD5zEGy/GgDYiOAdxK13xIiMstQnQUIDTDut+xDCdbgOg4wHo8SuE12NsDRMcBwk5D8BSD0sJh5UZRCUCI9cFDjMssRDbqRWUAhdg1zMp6WJy9pQxSOUCIHct3SjgjID6VCHoFIPS2Y2P2iIB4mRC9BhB6a7ELLzIjUSNh2/gFyB/R7rsgGlFEuKBZLMIJRMOKTFxvtLkqgNCbjSvZsALidD2IKgFCbxJuoh9W4UBvXUFZZ3hewUhswrbyYtUZKLQG4GpORFGg64qFqgCi4utFCM/D8WIGrQJgGF734JLCSd3NhtIY1WK9iPBwIxvGWuHxvviKG7jfBOT3/hBoZSwvhtZ6AEULjg64MwUPYQUm4FmzbJSfsIWs/ZWBmPfjDXgvrTY+D5mY88I+rK4KoOjv+/Eun34hzqZgXMFk9K8C4BQO4xwWYDTu4g7mp2B0v6j2lbm3Lse/XkHUTUzFU/EjTz6Sg+pYPMdAPMbH7IgdAwjxN1m8b0unzsGlvIooyIgd2ICoiSf1CNrNwMWcfGZm4dWeGdcQfWBojbsafvq1CzAKg2u/70oUUfF7cj0y9QpHEYX6uRMZ6MmqMSGfSUseTPGm//kFAJG9IcmEOX4AAAAASUVORK5CYII=",_icon_drag_start:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAhxJREFUWEft1kvITHEYx/HPu2EhRYnEwpawkZV7IgrJZcEKJRGFhcsKK1m4RBZs3BZKSZIUC5QoiY0QCxYkykYWFoqe+o+OMTPv/z9nXi/lqWk6M8//PN/ze26nzyBb3yDH9x+grgJzcadOGksBxuEd9mNOJfCBBDIBb0qAcgHWYR8iwEEsw9YUdBvW4gXCLwAC6GwOSA5ABH2NpXiKW/iGiZUA33Eee7EQZzA+qdWRIwcg5A5rfG9PaoxsAtiBY+m3e/iM4Qn2Mi7iUzPNQAE8x1AswWhcwq5WaRkogI94hRnpiU9iDFZ1o0CjmKLAGhb1cK1yfQQ7K9cPcT0VYyN90TXzSgEuYD6uYnNOVSefSXhW8W+0bRFAHJqKl/haKcICjp+uxQCLU1vNxJqmLvgjAEcxAusRcoZVJS2FKFbgNu7WlL0K+e8BXEnFt7tU6zb+xQrEgolVu7JHAPFA77Eldw5EAcY8P5wWSx2OIfiA2BW/bchOo3h1muEbakKsQCyj6KbYEb9Yf7tgEW5gE053KcPbNLZbTtL+ACJmLJRIxx4cKoSIdo50zsKXVmdzAOLcNJxLIzneBwKok43FCczGctxv55wL0Dgf7RSvZsfxAI9Tu8b/UWwLMD35nEpFHGu5rZUCxI2imDamV7IpGIYniL0RQPGJtruZk65uAJrvOwqT8ahdnnutQM6DZfv0QoHsYHW6oFaQvzoFPwAAmG4hmL5K1gAAAABJRU5ErkJggg==",_icon_code:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAf5JREFUWEftl79rFEEUx79v4FotQqwsTB1IZWmRNBYai0BiKRF2392hV8RKsDAH/gdy4e7NgmdrSCFoI0LSpEwRCLZerQimOzhunsw5e2zMSbjcJkvITbXszrz5zPf9mLeEggcVvD+mAKcUiKJokYjWAKwR0ax3kXNuKUmSvXHc5e0YY3bDmg6AxDm3/6+dUwDM/ArAm+xmOQAMzKnqlrX2Wdb2KIDvAO6o6vDEqlo/jwJE9DrdjIgWVfWntfbWWQAaaPestUvjyP6/uXEc73oA/11EThx6lAJTgGusQDZ3fRZcRBAS0Xyr1fo2zI5s5DLzWwDPw7sdEVnNIwvK5fI7VV0PtjZFpD4ECJVvxhizrKqPAMyENHxqrW3nARBF0QNjzOdg65iI9p1z26raIWYeBF1mfAWwXSqVdhqNxq88AJj5JoAqgIcA7p0oRIUDFO6CAoKwLiKbI7Og8DT0VGlMZOsAM98H0ALwPqWv1Wo3ut3uR7+m1+uttNvt32G9P92qMeZls9n85N9NfBkx8wffoADoiMicN1qtVhf6/f6hf3bO3U2S5CAAHAGY/3vxSTkXgGDYK+CL05fUf8w88GXWp5VKZdk590REHqfzJlZg0lpwtQDiOP7hm9EiWzLva87KfqlNaQi4DQAvANwOUX55bfmkATfu+umvWeEK/AFYAJFq0iBzXAAAAABJRU5ErkJggg==",_icon_design:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAABBBJREFUWEfFl1mIXUUQhv86CAHBxzwEQXxRXNA4JLhBHBRUhEBccERRBLldDerkQSOCC+OOkkwEdZSuvkpQUDBRRxExuCGJGcVM4oYE9zyYgD4p+OTcLik9Zzj3zFnuBGQaDvfC6e7/66rqqjqEFR60wvroBGBmTinN9/v9+eXAOudOjTF+17WmFYCZlYj2qOoGALeLyEzXhvbeey8ppSuJaDWACRHZ2bSuEcDEATwoIg/0er2zsyz7DMB9IjLdBsHMzwM4S0TOZeZrAbzaBlELUBYvxLz3Z6jqXgDbROSxOghmPkhEFEI4p3jfBbEEoE68AvE+ADHLlCGY+SUA4wD+JKKJEMK3JYibAeyos8QQQJt4BeJtAC8WEM65l4noRBEZd849TkQbR4VYBGBmO9EaEfFlsZTSTIzx4vJpc3dYYO0kotNVdbWIXFI68XYAlzVBiMii7uKfXq+3Lsuy/UR0YQhhLhexANpVNXce6RYTcwC+F5H11Zjw3s+o6ngNxO8ANojIIVtTdQEDeArALQDuaRK3hcxscCeIyBVNt6IKwcz7AcyXrVwXhAbxrKruiDH26tyRix8vIhu78oJzbpqILs8Pu7csvsQCxWb5opuIaFPZHUT0gqqeD2CViGzqEi/FxBEAR+pc1ZaINgO4C8Dd5g4ielhVryGi40IIVy9D/HMAB6onL9a3pmLn3BYi2grAWVSrKsUYLbuNNJj5UwBfNok3uqC8u3NulojsGu4WkYmRlP8L0m8AfNImPhKABZwVlRDCUC7oqAd7AJwJYFpEHm2b21UN7apZ3l3OyT8GcEhVnyOi1+w3xritCaItCI9F/MM8Mf2bTb33F6iq7bNVRCy/LBlN1fBYxK1I/Vj1eQ7xJoD7RSRUCeoS0ZT5b5lm301Eh1X1PVW9taZ2mCXetWttZbQMsQTAe/96SumtGKOVz87BzO8AOArABMxyV4nIbHVhbomPAGwuQ9RZ4Id8k6+71L33c6p6GoCHAGxX1UtjjOaK2pFD7EsprS96zGoxOgnA4XK5bNqMmc2vfwD4CcAUEd0QQnilmG+dUJ07mNni4GhRYYcAnHPWSDwhInaHGwczv0FEf4UQbrRJzGzuusgaEeuEmtqwvOeYqu0H8o3uVVVrp62Fqh3MvAvA3yJyfXlCvrlVUkvd1pAMdcN14ra+aoHZLMs+CCE8bS8nJydXLSwsjA0GgzEiGkspnZJl2W8hhOvq6JjZegjLfHeIyJMld1i3NXTy4l0V4Ncsy7aklNYS0VoA9qwB8AuAL/LCMtSMVkGY+U4Aj6SUzuv3+181nbwWgJn3AThZVa29tufAYDA42O/3f+66ERV33AbgmeKjpi2oOz/NliNcnpv3mOuqiae63/8GMCr4igP8A88tOz9MyKreAAAAAElFTkSuQmCC",_connectionTypes:{Flowchart:{anchor:"Continuous",connector:["Flowchart",{stub:[5,15],gap:5,cornerRadius:5,alwaysRespectStubs:!0}]},Straight:{anchor:"Continuous",connector:["Straight",{stub:[5,15],gap:5,cornerRadius:25,alwaysRespectStubs:!0}]},Bezier:{anchor:"Continuous",connector:["Bezier",{stub:[5,15],gap:5,cornerRadius:25,alwaysRespectStubs:!0}]},StateMachine:{anchor:"Continuous",connector:["StateMachine",{stub:[5,15],gap:5,cornerRadius:25,margin:5,alwaysRespectStubs:!0}]}},_initHtml:function(t){var e=this,i="";0==e.editable&&(i="state");var n="";0!=e.show_toolbar&&"false"!=e.show_toolbar||(n="toolbar_hide");var a=e.metadata_style;null!=a&&""!=a||("top"==e.metadata_position?a="metadata_float_top":"left"==e.metadata_position&&(a="metadata_float_left"));var s='<div class="andflow  '+a+" "+i+" "+n+'">';s+='<div class="metadata" >',s+='<div class="tags">',s+='<select id="tag_select">',s+="</select>",s+="</div>",s+='<div class="actions">',s+='<ul id="actionMenu" class="actionMenu" >',s+="</ul>",s+="</div>",s+="</div>",s+='<div class="designer">',s+='<div class="flow_tools">',s+='<div class="left">',s+='<a class="nav_btn">&nbsp;</a>',s+="</div>",s+='<div class="right">',s+='<a class="code_btn" title="code">&nbsp;</a>',s+='<a class="scale_down_btn" title="缩小">-</a>',s+='<a class="scale_info" title="还原"><span class="scale_value">100</span><span>%</span></a>',s+='<a class="scale_up_btn"  title="放大">+</a>',s+='<a class="thumbnail_btn"  title="缩略图">&nbsp;</a>',s+="</div>",s+="</div>",s+='<div class="flow_thumbnail">',s+='<div class="flow_thumbnail_mask"></div>',s+="</div>";var o="";e.show_grid||(o="background:none"),s+='<div id="canvasContainer" class="canvasContainer" style="'+o+'">',s+='<div id="canvas" class="canvas"></div>',s+="</div>",s+='<div id="codeContainer" class="codeContainer">',s+="<textarea></textarea>",s+="</div>",s+="</div>",s+="</div>",$("#"+t).html(s),$("#"+t).find(".nav_btn").css("background-image","url("+this._icon_nav+")"),$("#"+t).find(".nav_btn").attr("state","open"),$("#"+t).find(".nav_btn").bind("click",function(t){var i=$("#"+e.containerId).find(".nav_btn");"open"==i.attr("state")?(i.attr("state","close"),$("#"+e.containerId).find(".andflow").addClass("fold")):(i.attr("state","open"),$("#"+e.containerId).find(".andflow").removeClass("fold"))}),$("#"+t).find(".scale_up_btn").bind("click",function(t){var i=1*$("#"+e.containerId).find(".scale_value").html(),n=(i+=1)/100;$("#"+e.containerId).find(".canvas").css("transform","scale("+n+")"),$("#"+e.containerId).find(".scale_value").html(i)}),$("#"+t).find(".scale_down_btn").bind("click",function(t){var i=1*$("#"+e.containerId).find(".scale_value").html(),n=(i-=1)/100;$("#"+e.containerId).find(".canvas").css("transform","scale("+n+")"),$("#"+e.containerId).find(".scale_value").html(i)}),$("#"+t).find(".scale_info").bind("click",function(t){$("#"+e.containerId).find(".canvas").css("transform","scale(1)"),$("#"+e.containerId).find(".scale_value").html("100")});var r=$("#"+t).find(".canvasContainer");$("#"+t).find(".canvas").bind("mousedown",function(i){var n=$("#"+t).find(".canvas");n.attr("drag","true"),n.attr("offset_x",i.offsetX),n.attr("offset_y",i.offsetY),n.addClass("canvas-move"),e._resizeCanvas()}),$("#"+t).find(".canvas").bind("mouseup",function(i){var n=$("#"+t).find(".canvas");"true"==n.attr("drag")&&e._onCanvasChanged(),n.attr("drag","false"),n.attr("offset_x",i.offsetX),n.attr("offset_y",i.offsetY),n.removeClass("canvas-move")}),$("#"+t).find(".canvas").bind("mouseout",function(e){var i=$("#"+t).find(".canvas");i.attr("drag","false"),i.attr("offset_x",e.offsetX),i.attr("offset_y",e.offsetY)}),$("#"+t).find(".canvas").bind("mousemove",function(e){var i=$("#"+t).find(".canvas");if("true"==i.attr("drag")){let t=i.attr("offset_x"),n=i.attr("offset_y"),a=e.offsetX-t,s=e.offsetY-n;scrollLeft=r.scrollLeft()-a,scrollTop=r.scrollTop()-s,r.scrollLeft(scrollLeft),r.scrollTop(scrollTop)}}),$("#"+t).find(".code_btn").css("background-image","url("+e._icon_code+")"),$("#"+t).find(".code_btn").bind("click",function(i){try{if($("#codeContainer").is(":visible")){var n=$("#codeContainer textarea").val()||"{}",a=JSON.parse(n);$("#codeContainer").hide(),e.showFlow(a),$("#"+t).find(".code_btn").css("background-image","url("+e._icon_code+")")}else{var s=e.getFlow(),o=JSON.stringify(s,null,"\t");$("#codeContainer").show(),$("#codeContainer textarea").val(o),$("#"+t).find(".code_btn").css("background-image","url("+e._icon_design+")")}}catch(i){console.error(i)}}),$("#"+t).find(".thumbnail_btn").css("background-image","url("+this._icon_eye_close+")"),$("#"+t).find(".thumbnail_btn").attr("state","close"),$("#"+t).find(".thumbnail_btn").bind("click",function(t){var i=$("#"+e.containerId).find(".flow_thumbnail"),n=$("#"+e.containerId).find(".thumbnail_btn");"open"==n.attr("state")?(n.attr("state","close"),n.css("background-image","url("+e._icon_eye_close+")"),i.hide()):(n.attr("state","open"),n.css("background-image","url("+e._icon_eye+")"),i.show(),e._showThumbnail())}),$("#"+t).find(".flow_thumbnail_mask").mousedown(function(t){var i=t.offsetX,n=t.offsetY;$("#"+e.containerId).mousemove(function(t){var a=$("#"+e.containerId).find(".flow_thumbnail_mask");if(a.length>0){var s=t.pageX-a.parent().offset().left-i,o=t.pageY-a.parent().offset().top-n;s<0&&(s=0),o<0&&(o=0),s+a.outerWidth()>a.parent().width()&&(s=a.parent().width()-a.outerWidth()),o+a.outerHeight()>a.parent().height()&&(o=a.parent().height()-a.outerHeight()),a.css("left",s+"px"),a.css("top",o+"px");var r=$("#"+e.containerId).find(".canvas").parent().width()/a.width(),l=a.position().left*r,d=a.position().top*r;$("#"+e.containerId).find(".canvas").parent().scrollLeft(l),$("#"+e.containerId).find(".canvas").parent().scrollTop(d)}})})},_initAnimaction:function(){var t=this;this.animation_timer&&clearInterval(this.animation_timer),this.animation_timer=setInterval(function(){var e=t._plumb.getAllConnections();for(var i in e){var n=e[i];if(t.getLinkInfo(n.sourceId,n.targetId).animation){var a=n.getOverlay("arrow_source"),s=n.getOverlay("arrow_target"),o=0;!a.visible&&s.visible?o=1:a.visible&&!s.visible&&(o=2),(r=n.getOverlay("animation")).setVisible(!0),1==o?(r.loc=r.loc+.05,r.loc>.9&&(r.loc=.1)):2==o?(r.loc=r.loc-.05,r.loc<.1&&(r.loc=.9)):null==r.diract||1==r.diract?(r.loc=r.loc+.05,r.loc>.9&&(r.diract=2)):(r.loc=r.loc-.05,r.loc<.1&&(r.diract=1))}else{var r;(r=n.getOverlay("animation")).setVisible(!1)}}},100)},_initEvents:function(){var t=this;$("#"+t.containerId).mouseup(function(e){$(this).unbind("mousemove"),$(this).css("cursor","default"),t._drag_name=null,$("#drag_helper").remove()}),$(document).mouseup(function(e){$("#"+t.containerId).unbind("mousemove"),$("#"+t.containerId).css("cursor","default"),t._drag_name=null,$("#drag_helper").remove()})},_initTheme:function(t){this.setTheme(t)},_initMetadata:function(){var t=this,e=this.tags||[],i=this.metadata||[];null==e&&(e=[]),null==i&&(i=[]);var n="<script>\n";for(var a in i)n+=i[a].params_script||"",n+="\n";if(n+="<\/script>",$("body").append(n),$("#tag_select").length>0){for(var a in $("#tag_select").html(""),$("#tag_select").append('<option value="">'+t.lang.metadata_tag_all+"</option>"),e){var s=e[a];null!=s&&""!=s&&$("#tag_select").append('<option value="'+s+'">'+s+"</option>")}$("#tag_select").on("change",function(e){var i=$(this).val();t._showMetadata(i)}),t._showMetadata($("#tag_select").val())}else t._showMetadata("")},_dropComponent:function(t,e,i){var n=this.getMetadata(t);if("group"==n.tp){var a={id:"group_"+jsPlumbUtil.uuid().replaceAll("-",""),name:n.name,left:e,top:i,actions:[]};this._createGroup(a)}else if("list"==n.tp){var s={id:"list_"+jsPlumbUtil.uuid().replaceAll("-",""),name:n.name,left:e,top:i,items:[]};this._createList(s)}else if("tip"==n.tp){var o={id:"tip_"+jsPlumbUtil.uuid().replaceAll("-",""),name:n.name,left:e,top:i,content:""};this._createTip(o)}else{var r={id:jsPlumbUtil.uuid().replaceAll("-",""),left:e,top:i,name:t,params:{}};if(null!=n)for(var l in n.params){var d=n.params[l],c=(t=d.name,d.default);c&&(r.params[t]=c)}if("begin"==t&&$(".action[name='begin']").length&&$(".action[name='begin']").length>0)return;if("end"==t&&$(".action[name='end']").length&&$(".action[name='end']").length>0)return;r.title=r.title||n.title,this._createAction(r)}},_initPlumb:function(){var t=this;null!=t._plumb&&(t._plumb.destroy(),$("#"+this.containerId+" #canvas").html(""));var e=this.flowModel.link_type||"Flowchart",i=this._themeObj.default_link_color,n=this._themeObj.default_link_radius,a=this._themeObj.default_link_strokeWidth,s=this._themeObj.default_link_color_hover,o=this._themeObj.default_link_strokeWidth_hover,r=this._themeObj.default_link_outlineWidth,l=this._themeObj.default_endpoint_stroke_color,d=this._themeObj.default_endpoint_stroke_color_hover,c=this._themeObj.default_endpoint_fill_color,h=this._themeObj.default_endpoint_fill_color_hover,u=this._themeObj.default_endpoint_radius,_=this._themeObj.default_endpoint_radius_hover,f=this._themeObj.default_endpoint_strokeWidth,p=this._themeObj.default_endpoint_strokeWidth_hover,v=t._connectionTypes[e].connector;for(var g in v.cornerRadius=n,this._plumb=jsPlumb.getInstance({Endpoint:["Dot",{radius:5}],Connector:v,Anchor:"Center",EndpointStyle:{stroke:l,fill:c,radius:u,strokeWidth:f},EndpointHoverStyle:{stroke:d,fill:h,radius:_,strokeWidth:p},PaintStyle:{stroke:i,radius:n,strokeWidth:a,outlineStroke:"transparent",outlineWidth:r},HoverPaintStyle:{stroke:s,strokeWidth:o},ConnectionOverlays:[["Arrow",{location:0,id:"arrow_source",length:10,width:10,direction:-1,foldback:.8,show:!1}],["Label",{label:"X",id:"label_remove",cssClass:"linkBtn",visible:!1,events:{tap:function(e,i){t._plumb.deleteConnection(e.component)}}}],["Label",{label:"",id:"label",cssClass:"linkLabel",visible:!1}],["Label",{id:"label_source",location:20,label:"",cssClass:"linkLabelSource",visible:!1}],["Label",{id:"label_target",location:-20,label:"",cssClass:"linkLabelTarget",visible:!1}],["Arrow",{location:1,id:"arrow_target",length:10,width:10,foldback:.8,show:!0}],["Arrow",{location:.5,id:"arrow_middle",length:10,width:10,foldback:.8,show:!1}],["Diamond",{location:.5,id:"animation",length:10,width:10,show:!1}]],Container:"canvas"}),t._connectionTypes)t._plumb.registerConnectionType(g,t._connectionTypes[g]);this._plumb.bind("connection",function(e,i){try{var n=e.sourceId,a=e.targetId,s=e.connection.data;null==s&&null==(s=t._linkInfos[n+"-"+a])&&(s={}),s.source_id=n,s.target_id=a,t._linkInfos[n+"-"+a]=s,t._paintConnection(e.connection,s),t._onCanvasChanged()}catch(t){}}),this._plumb.bind("connectionDetached",function(e){var i=e.sourceId,n=e.targetId;t.delLinkInfo(i,n),t._plumb.repaintEverything()}),this._plumb.bind("connectionMoved",function(e){var i=e.originalSourceId,n=e.originalTargetId;t.delLinkInfo(i,n),t._plumb.repaintEverything()}),this._plumb.bind("beforeDetach",function(e){return!!t.editable}),this._plumb.bind("beforeDrop",function(e){if(!t.editable)return!1;var i=e.sourceId,n=e.targetId;return null==t._linkInfos[i+"-"+n]}),this._plumb.bind("click",function(e,i){if(t.editable)if(i.preventDefault(),t.event_link_click&&t.event_link_dblclick)t._timer_link&&clearTimeout(t._timer_link),t._timer_link=setTimeout(function(){var i=e.sourceId,n=e.targetId,a=t.getLinkInfo(i,n);t.event_link_click(a)},300);else if(t.event_link_click){var n=e.sourceId,a=e.targetId,s=t.getLinkInfo(n,a);t.event_link_click(s)}}),this._plumb.bind("dblclick",function(e,i){if(i.preventDefault(),t.editable&&t.event_link_dblclick){t._timer_link&&clearTimeout(t._timer_link);var n=e.sourceId,a=e.targetId,s=t.getLinkInfo(n,a);t.event_link_dblclick(s)}}),$("#canvas").bind("click",function(e){t.event_canvas_click&&t.event_canvas_click(e)})},_showMetadata:function(t){var e=this,i=this.metadata,n={};for(var a in i)if(!(t&&t.length>0&&i[a].tag&&i[a].tag.length>0&&i[a].tag!=t)){var s=i[a].group||"通用";null==n[s]&&(n[s]=[]),n[s].push(i[a])}$("#actionMenu").html("");for(var o in n){var r='<li class="actionMenuGroup"  ><a href="#" class="group-title">'+o+'<i class="pull-right ico"></i></a></li>',l=n[o];for(var a in l){var d=l[a].name,c=l[a].title,h=l[a].icon||"img/node.png",u="";h&&h.length>0&&(u='<img src="'+(e.img_path||"")+h+'" draggable="false" />'),r+='<li id="'+d+'"  action_name="'+d+'" action_title="'+c+'" class="actionMenuItem"  action_icon="'+h+'" ><a class="item-title">'+u+c+"</a></li>"}$("#actionMenu").append(r),0}$("#actionMenu li.actionMenuItem").bind("mousedown",function(t){var i=$(this);if(!$("#codeContainer").is(":visible")){t.offsetX,t.offsetY;var n=i.attr("action_name");e._drag_name=n,$("#"+e.containerId).find(".andflow").mousemove(function(t){if(null!=e._drag_name){var i=$("#"+e.containerId).find(".andflow").find("#drag_helper");if(null==i||0==i.length){if(null==(i=e._createHelper(e._drag_name)))return;$("#"+e.containerId).find(".andflow").append(i)}var n=i.width()/2||10,a=i.height()/2||10,s=t.pageX-$("#"+e.containerId).find(".andflow").offset().left-n,o=t.pageY-$("#"+e.containerId).find(".andflow").offset().top-a;i.css("left",s+"px"),i.css("top",o+"px"),i.attr("p_x",n),i.attr("p_y",a)}})}})},_createHelper:function(t){var e=this;if(null!=t){var i=e.getMetadata(t);if(null!=i){var n=i.icon,a=i.title,s=$('<div class="action-drag"></div>'),o=$('<div class="action-drag-main" ><div class="action-header">'+a+'</div><div class="action-icon"><img src="'+(e.img_path||"")+n+'"  draggable="false"/></div></div>');"group"==i.tp?(s=$('<div class="group-drag"></div>'),o=$('<div class="group-drag-main"><div class="group-header">'+a+'</div><div class="group-body"></div></div>')):"list"==i.tp?(s=$('<div class="list-drag"></div>'),o=$('<div class="list-drag-main"><div class="list-header">'+a+'</div><div class="list-body"></div></div>')):"tip"==i.tp?(s=$('<div class="tip-drag"></div>'),o=$('<div class="tip-drag-main"><div class="tip-header"></div><div class="tip-body">'+a+"</div></div>")):(s=$('<div class="action-drag"></div>'),o=$('<div class="action-drag-main" ><div class="action-header">'+a+'</div><div class="action-icon"><img src="'+(e.img_path||"")+n+'" draggable="false"/></div></div>'));var r=i.render_helper||i.render;if(r){let t=r(i);null!=t&&t.length>0&&(o=$(t))}return s.append(o),s.attr("id","drag_helper"),s.css("position","absolute"),s.find("img").attr("draggable","false"),s.bind("mouseup",function(t){var i=s.attr("p_x")||10,n=s.attr("p_y")||10,a=t.pageX-$("#"+e.containerId).find(".canvas").offset().left-1*i,o=t.pageY-$("#"+e.containerId).find(".canvas").offset().top-1*n;a>=0&&o>=0&&e._dropComponent(e._drag_name,a,o)}),s}}},_createGroup:function(t){var e=this;e.setGroupInfo(t);var i=t.id,n=t.name,a=this.getMetadata(n)||{},s=t.members||[],o='<div id="'+i+'" class="group group-container">';o+='<div class="group-remove-btn">X</div>',o+='<div class="group-resize"></div>',o+="</div>";var r=$(o),l='<div class="group-main"><div class="group-header"></div><div class="group-body"></div></div>';if(t.render)(d=t.render(a,t,l))&&d.length>0&&(l=d);else if(a.render){var d;(d=a.render(a,t,l))&&d.length>0&&(l=d)}group_main_element=$(l),group_main_element.addClass("group-master"),r.append(group_main_element);var c='<div class="group-ep" title="拖拉连线">→</div>';if(e.render_endpoint){var h=e.render_endpoint(action_meta,action,c);h&&h.length>0&&(c=h)}var u=$(c);u.removeClass("group-ep"),u.addClass("group-ep"),r.append(u),e._plumb.makeSource(r.get(0),{filter:".group-ep",anchor:"Continuous",extract:{action:"the-action"}}),e._plumb.makeTarget(r.get(0),{dropOptions:{hoverClass:"dragHover"},anchor:"Continuous",allowLoopback:!0});var _=$("#"+e.containerId+" #canvas");_.append(r),r.bind("mouseup",function(){e._onCanvasChanged()}),r.find(".group-remove-btn").bind("click",function(){confirm("确定删除分组?")&&e.removeGroup(i)}),r.find(".group-header").bind("dblclick",function(t){if(e.editable){if(t.preventDefault(),r.find(".group-header").find(".content_editor").length>0)return;var n=$('<input class="content_editor"  />');n.css("position","absolute"),n.css("z-index","9999"),n.css("left","0px"),n.css("top","0px"),n.css("width","100%"),n.css("height","100%"),n.css("box-sizing","border-box"),n.val(r.find(".group-header").html()),r.find(".group-header").append(n),n.focus(),n.on("blur",function(t){var a=n.val();n.parent().html(a),e._groupInfos[i].title=a,n.remove()}),n.on("keydown",function(t){if("Enter"==t.code){var a=n.val();n.parent().html(a),e._groupInfos[i].title=a,n.remove()}})}}),r.find(".group-body").bind("dblclick",function(t){if(e.editable){if(t.preventDefault(),r.find(".group-body").find(".content_editor").length>0)return;var n=$('<textarea class="content_editor"></textarea>');n.css("position","absolute"),n.css("z-index","9999"),n.css("left","0px"),n.css("top","0px"),n.css("width","100%"),n.css("height","100%"),n.css("box-sizing","border-box"),n.val(r.find(".group-body").html()),r.find(".group-body").append(n),n.focus(),n.on("blur",function(t){var a=n.val();n.parent().html(a),e._groupInfos[i].des=a,n.remove()})}}),r.find(".group-header").html(t.title||""),r.find(".group-body").html(t.des||"");if(null==t.left||"auto"==t.left){if(s.length>0){var f=9999999999999;for(var p in s){let t=$("#"+s[p]).offset().left-_.offset().left;f>t&&(f=t)}f-=10,r.css("left",f+"px")}}else(t.left+"").indexOf("px")>=0?r.css("left",t.left):r.css("left",t.left+"px");if(null==t.top||"auto"==t.top){if(s.length>0){var v=999999999;for(var p in s){let t=$("#"+s[p]).offset().top-_.offset().top;v>t&&(v=t)}v-=30,r.css("top",v+"px")}}else(t.top+"").indexOf("px")>=0?r.css("top",t.top):r.css("top",t.top+"px");if(null==t.width||"auto"==t.width){if(s.length>0){var g=0;for(var p in s)$("#"+s[p]).find("div").each(function(t,e){let i=$(e).offset().left+$(e).width();(i=i-r.position().left-_.offset().left)>g&&(g=i)});g+=10,group_main_element.width(g)}}else(t.width+"").indexOf("px")>=0?group_main_element.css("width",t.width):group_main_element.css("width",t.width+"px");if(null==t.height||"auto"==t.height){if(s.length>0){var m=0;for(var p in s)$("#"+s[p]).find("div").each(function(t,e){let i=$(e).offset().top+$(e).height();(i=i-r.position().top-_.offset().top)>m&&(m=i)});m+=10,group_main_element.height(m)}}else(t.height+"").indexOf("px")>=0?group_main_element.css("height",t.height):group_main_element.css("height",t.height+"px");if(r.find(".group-resize").mousedown(function(t){$("#"+e.containerId).css("cursor","nwse-resize");var i=r.find(".group-master"),n=t.pageX,a=t.pageY,s=i.width(),o=i.height();$("#"+e.containerId).mousemove(function(t){var l=t.pageX,d=t.pageY,c=s+(l-n),h=o+(d-a);i.css({width:c,height:h}),r.attr("width",c),r.attr("height",h),e._plumb.repaintEverything(),e._onCanvasChanged(),t.preventDefault()}),t.preventDefault()}),e._plumb.draggable(r.get(0),{stop:function(t){e.drag_step>1&&(x=Math.round(t.pos[0]/e.drag_step)*e.drag_step,y=Math.round(t.pos[1]/e.drag_step)*e.drag_step,$(t.el).css("left",x+"px"),$(t.el).css("top",y+"px"))}}),e._plumb.addGroup({el:r.get(0),id:i,orphan:!0,droppable:!0,dropOverride:!0,revert:!0,endpoint:["Dot",{radius:3}]}),s&&s.length>0){var b=[];for(var p in s)b.push($("#"+s[p]).get(0));e._plumb.addToGroup(i,b)}e._onCanvasChanged()},_createList:function(t){var e=this;e.setListInfo(t);var i=t.id,n=t.name,a=(this.getMetadata(n),t.items),s=t.left,o=t.top,r=(t.width,t.height,'<div id="'+i+'" class="list list-container">');r+='<div class="list-remove-btn">X</div>',r+='<div class="list-resize"></div>',r+='<div class="list-main">',r+='<div class="list-header">'+(t.title||"")+"</div>",r+='<div class="list-body"></div>',r+="</div>",r+="</div>";var l=$(r);$("#"+e.containerId+" #canvas").append(l),l.bind("mouseup",function(){e._onCanvasChanged()}),l.find(".list-remove-btn").bind("click",function(){confirm("确定删除?")&&e.removeList(i)});var d=l.find(".list-main");l.find(".list-resize").mousedown(function(t){$("#"+e.containerId).css("cursor","nwse-resize");var i=t.pageX,n=t.pageY,a=d.width(),s=d.height();$("#"+e.containerId).mousemove(function(t){var o=t.pageX,r=t.pageY,c=a+(o-i),h=s+(r-n);d.css({width:c,height:h}),l.attr("width",c),l.attr("height",h),e._plumb.repaintEverything(),e._onCanvasChanged(),t.preventDefault()}),t.preventDefault()}),l.find(".list-header").bind("dblclick",function(t){if(e.editable){if(t.preventDefault(),l.find(".list-header").find(".content_editor").length>0)return;let n=$('<input class="content_editor"  />');n.css("position","absolute"),n.css("z-index","9999"),n.css("left","0px"),n.css("top","0px"),n.css("width","100%"),n.css("height","100%"),n.css("box-sizing","border-box"),n.val(l.find(".list-header").html()),l.find(".list-header").append(n),n.focus(),n.on("blur",function(t){var a=n.val();n.parent().html(a),e._listInfos[i].title=a,n.remove(),e._onCanvasChanged()}),n.on("keydown",function(t){if("Enter"==t.code){var a=n.val();n.parent().html(a),e._listInfos[i].title=a,n.remove(),e._onCanvasChanged()}})}}),l.find(".list-body").bind("dblclick",function(t){if(e.editable){if(t.preventDefault(),l.find(".list-body").find(".content_editor").length>0)return;let o=$("<textarea></textarea>");o.addClass("content_editor"),o.css("position","absolute"),o.css("z-index","9999"),o.css("left","0px"),o.css("top","0px"),o.css("width","100%"),o.css("height","100%"),o.css("box-sizing","border-box");var n=e._listInfos[i].items,a="";if(n&&n.length>0)for(var s in n)a+=n[s].title+"\n";o.val(a),l.find(".list-body").append(o),o.focus(),o.on("blur",function(t){var n=$(this).val();$(this).remove();var a=n.split("\n"),s=[];for(var o in a){var r="list_item_"+i+"_"+o,l=a[o];if(null!=l&&""!=l.trim()){var d={id:r,title:a[o]};s.push(d)}}e._setListItems(i,s),e._onCanvasChanged()})}}),(o+"").indexOf("px")>=0?l.css("top",o):l.css("top",o+"px"),(s+"").indexOf("px")>=0?l.css("left",s):l.css("left",s+"px"),e._plumb.draggable(l.get(0),{stop:function(t){e.drag_step>1&&(x=Math.round(t.pos[0]/e.drag_step)*e.drag_step,y=Math.round(t.pos[1]/e.drag_step)*e.drag_step,$(t.el).css("left",x+"px"),$(t.el).css("top",y+"px"))}}),e._plumb.addList(l.get(0),{endpoint:["Rectangle",{width:20,height:20}]}),e._setListItems(i,a),e._onCanvasChanged()},_setListItems:function(t,e){if(this._listInfos[t].items=e,$("#"+t).find(".list-item").length>0){var i=[];for(var n in $("#"+t).find(".list-item").each(function(t,n){let a=$(n).attr("id"),s=!1;for(var o in e)a==e[o].id&&(s=!0);s||i.push($(n))}),i){let t=i[n].attr("id");this.removeLinkBySource(t),this.removeLinkByTarget(t),this._plumb.remove(i[n].get(0)),i[n].remove()}}for(var n in e){var a=e[n];if(null!=a.id&&null!=a.title&&""!=a.title){var s=a.id,o=$("#"+t).find(".list-body").find("#"+s);if(0==o.length){o=$('<div id="'+s+'" class="list-item"><div class="list-item-title"></div></div>'),$("#"+t).find(".list-body").append(o);var r=o.get(0);this._plumb.makeSource(r,{allowLoopback:!1,anchor:["Left","Right"]}),this._plumb.makeTarget(r,{allowLoopback:!1,anchor:["Left","Right"]})}o.find(".list-item-title").html(a.title||"")}}},_deleteListItem:function(t,e){for(var i in this._listInfos[t].items)this._listInfos[t].items[i].id==e&&(this._listInfos[t].items[i]=null)},_createAction:function(t){var e=this,i=t.id;if(null!=i){var n=t.name;if(null!=n){this.setActionInfo(t);var a=this.getMetadata(n)||{},s=t.title||t.des||a.title||a.des||"",o=t.icon||a.icon||"",r=(t.des||a.des,t.css||a.css||""),l=t.theme||a.theme||"",d=action_themes[l||""]||this._themeObj,c=t.content,h=t.left,u=t.top,_=t.width,f=t.height,p="",v="";d.is_body_resizable&&(p=t.body_width,v=t.body_height);var g='<div class="action-main">';g+='<div class="action-icon"  >'+(o&&o.length>0?'<img src="'+(e.img_path||"")+o+'" >':'<img src="'+(e.img_path||"")+'node.png">')+"</div>",g+='<div class="action-header">'+s+"</div>";var m="";"false"==this.flowModel.show_action_body&&(m='style="visibility: hidden"');var b="";if("false"==this.flowModel.show_action_content&&(b='style="visibility: hidden"'),g+='<div class="action-body" '+m+">",g+='<div class="action-content" '+b+"></div>",g+='<div class="body-resize"></div>',g+="</div>",g+="</div>",t.render)(A=t.render(a,t,g))&&A.length>0&&(g=A);else if(a.render){var A;(A=a.render(a,t,g))&&A.length>0&&(g=A)}var k=$('<div id="'+i+'"  draggable="true" ondragend="" class="action-container '+l+'"><div  class="action  '+r+'" name="'+n+'" title="'+s+'" icon="'+o+'"></div></div>');action_main_el=$(g),action_main_el.addClass("action-master"),k.find(".action").append(action_main_el);var w='<div class="ep" title="拖拉连线">→</div>';if(e.render_endpoint){var C=e.render_endpoint(a,t,w);C&&C.length>0&&(w=C)}var I=$(w);I.removeClass("ep"),I.addClass("ep"),k.append(I);var y='<div class="action-resize"></div>';if(e.render_btn_resize){var x=e.render_btn_resize(a,t,y);x&&x.length>0&&(y=x)}var O=$(y);O.removeClass("action-resize"),O.addClass("action-resize"),k.find(".action").append(O);var E='<a href="javascript:void(0)" class="action-remove-btn"  >X</a>';if(e.render_btn_remove){var S=e.render_btn_remove(a,t,E);S&&S.length>0&&(E=S)}var j=$(E);j.removeClass("action-remove-btn"),j.addClass("action-remove-btn"),k.find(".action").append(j),$("#"+e.containerId+" #canvas").append(k),c&&("string"==typeof c&&(c={content_type:"msg",content:c}),this.setActionContent(i,c.content||"",c.content_type||"msg")),k.css("position","absolute").css("left",h).css("top",u),_&&_.length>0&&(k.css("width",_),k.find(".action-master").css("width",_)),f&&f.length>0&&(k.css("height",f),k.find(".action-master").css("height",f)),p&&p.length>0?(k.attr("body_width",p),k.find(".action-body").css("width",p)):k.find(".action-body").css("width",""),v&&v.length>0?(k.attr("body_height",v),k.find(".action-body").css("height",v)):k.find(".action-body").css("height",""),k.bind("mouseup",function(){e._onCanvasChanged()}),k.find(".action-remove-btn").bind("click",function(){confirm("确定删除该节点?")&&e.removeAction(i)}),k.bind("click",function(i){e.editable&&(e.event_action_click&&e.event_action_dblclick?(e._timer_action&&clearTimeout(e._timer_action),e._timer_action=setTimeout(function(){e.event_action_click(a,t)},300)):e.event_action_click&&e.event_action_click(a,t))}),k.bind("dblclick",function(i){e.editable&&e.event_action_dblclick&&(e._timer_action&&clearTimeout(e._timer_action),e.event_action_dblclick(a,t))}),k.bind("mouseover",function(t){"end"!=$(this).attr("name")&&$(this).find(".ep").show()}),k.bind("mouseout",function(t){$(this).find(".ep").hide()}),k.find(".action-resize").mousedown(function(t){$("#"+e.containerId).css("cursor","nwse-resize");$(this)[0];var n=t.pageX,a=t.pageY,s=$("#"+i).find(".action-master").width(),o=$("#"+i).find(".action-master").height();$("#"+e.containerId).mousemove(function(t){var r=t.pageX,l=t.pageY,d=s+(r-n),c=o+(l-a),h=1*$("#"+i).find(".action-master").css("min-width").replace("px",""),u=1*$("#"+i).find(".action-master").css("min-height").replace("px","");(null==h||d>h)&&($("#"+i).find(".action-master").css({width:d+"px"}),$("#"+i).css({width:d+"px"})),(null==u||c>u)&&($("#"+i).find(".action-master").css({height:c+"px"}),$("#"+i).css({height:c+"px"}));var _=e._actionCharts[i];if(null!=_){var f=$("#chart_"+i).parent().width(),p=$("#chart_"+i).parent().height();$("#chart_"+i).css({width:f,height:p}),_.resize()}e._plumb.repaintEverything(),e._onCanvasChanged(),t.preventDefault()}),t.preventDefault()}),k.find(".body-resize").mousedown(function(t){$("#"+e.containerId).css("cursor","nwse-resize");$(this)[0];var n=t.pageX,a=t.pageY,s=$("#"+i).find(".action-body").width(),o=$("#"+i).find(".action-body").height();$("#"+e.containerId).mousemove(function(t){var r=t.pageX,l=t.pageY,d=s+(r-n),c=o+(l-a);$("#"+i).find(".action-body").css({width:d,height:c}),$("#"+i).attr("body_width",d),$("#"+i).attr("body_height",c);var h=e._actionCharts[i];if(null!=h){var u=$("#chart_"+i).parent().width(),_=$("#chart_"+i).parent().height();$("#chart_"+i).css({width:u,height:_}),h.resize()}e._plumb.repaintEverything(),e._onCanvasChanged(),t.preventDefault()}),t.preventDefault()}),this._showActionNode(k,n),e._onCanvasChanged()}}},_showActionNode:function(t,e){var i=this;this._plumb.draggable(t.get(0),{stop:function(t){i.drag_step>1&&(x=Math.round(t.pos[0]/i.drag_step)*i.drag_step,y=Math.round(t.pos[1]/i.drag_step)*i.drag_step,$(t.el).css("left",x+"px"),$(t.el).css("top",y+"px"))}}),null!=e&&"end"==e||this._plumb.makeSource(t.get(0),{filter:".ep",anchor:"Continuous",extract:{action:"the-action"},maxConnections:20,onMaxConnections:function(t,e){showWarning("已经达到连接最大数 ("+t.maxConnections+") ")}}),null!=e&&"begin"==e||this._plumb.makeTarget(t.get(0),{dropOptions:{hoverClass:"dragHover"},anchor:"Continuous",allowLoopback:!0})},_createTip:function(t){var e=this;e.setTipInfo(t);var i=t.id,n=t.name,a=t.content,s=this.getMetadata(n)||{},o='<div id="'+i+'" class="tip tip-container">';o+='<div class="tip-remove-btn">X</div>',o+='<div class="tip-resize"></div>',o+="</div>";var r=$(o);a&&(a=a.replaceAll("\n","<br/>"));var l='<div class="tip-main"><div class="tip-header"></div><div class="tip-body"></div></div>';if(t.render)(d=t.render(s,t,l))&&d.length>0&&(l=d);else if(s.render){(d=s.render(s,t,l))&&d.length>0&&(l=d)}else if(e.render_tip){var d;(d=e.render_tip(s,t,l))&&d.length>0&&(l=d)}tip_main_element=$(l),tip_main_element.addClass("tip-master"),r.append(tip_main_element);var c='<div class="tip-ep" title="拖拉连线">→</div>';if(e.render_endpoint){var h=e.render_endpoint(action_meta,action,c);h&&h.length>0&&(c=h)}var u=$(c);u.removeClass("tip-ep"),u.addClass("tip-ep"),r.append(u),this._plumb.getContainer().appendChild(r.get(0)),this._plumb.draggable(r.get(0),{stop:function(t){e.drag_step>1&&(x=Math.round(t.pos[0]/e.drag_step)*e.drag_step,y=Math.round(t.pos[1]/e.drag_step)*e.drag_step,$(t.el).css("left",x+"px"),$(t.el).css("top",y+"px"))}}),e._plumb.makeSource(r.get(0),{filter:".tip-ep",anchor:"Continuous"}),e._plumb.makeTarget(r.get(0),{dropOptions:{hoverClass:"dragHover"},anchor:"Continuous",allowLoopback:!0}),$("#"+e.containerId+" #canvas").append(r),r.bind("mouseup",function(){e._onCanvasChanged()}),r.find(".tip-remove-btn").bind("click",function(){confirm("确定删除?")&&e.removeTip(i)}),r.find(".tip-header").bind("dblclick",function(t){if(e.editable){if(r.find(".tip-header").find(".content_editor").length>0)return;var n=$('<input class="content_editor" />');n.css("position","absolute"),n.css("z-index","9999"),n.css("left","0px"),n.css("top","0px"),n.css("width","100%"),n.css("height","100%"),n.css("box-sizing","border-box"),n.val(r.find(".tip-header").html()),r.find(".tip-header").append(n),n.focus(),n.on("blur",function(t){var a=n.val();n.parent().html(a),e._tipInfos[i].title=a,n.remove(),e._onCanvasChanged()}),n.on("keydown",function(t){if("Enter"==t.code){var a=n.val();n.parent().html(a),e._tipInfos[i].title=a,n.remove(),e._onCanvasChanged()}})}}),r.find(".tip-body").bind("dblclick",function(t){if(e.editable){if(r.find(".tip-body").find(".content_editor").length>0)return;var n=$('<textarea class="content_editor"></textarea>');n.css("position","absolute"),n.css("z-index","9999"),n.css("left","0px"),n.css("top","0px"),n.css("width","100%"),n.css("height","100%"),n.css("box-sizing","border-box");var a=e._tipInfos[i].content;n.val(a),r.find(".tip-body").append(n),n.focus(),n.on("blur",function(t){var a=n.val();e._tipInfos[i].content=a,a=a.replaceAll("\n","<br/>"),n.parent().html(a),n.remove(),e._onCanvasChanged()})}}),r.find(".tip-header").html(t.title||""),r.find(".tip-body").html(a||""),(t.left+"").indexOf("px")>=0?r.css("left",t.left):r.css("left",t.left+"px"),(t.top+"").indexOf("px")>=0?r.css("top",t.top):r.css("top",t.top+"px"),(t.width+"").indexOf("px")>=0?tip_main_element.css("width",t.width):tip_main_element.css("width",t.width+"px"),(t.height+"").indexOf("px")>=0?tip_main_element.css("height",t.height):tip_main_element.css("height",t.height+"px"),r.find(".tip-resize").mousedown(function(t){$("#"+e.containerId).css("cursor","nwse-resize");var i=r.find(".tip-master"),n=t.pageX,a=t.pageY,s=i.width(),o=i.height();$("#"+e.containerId).mousemove(function(t){var l=t.pageX,d=t.pageY,c=s+(l-n),h=o+(d-a);i.css({width:c,height:h}),r.attr("width",c),r.attr("height",h),e._plumb.repaintEverything(),e._onCanvasChanged(),t.preventDefault()}),t.preventDefault()})},_showThumbnail:function(){var t=this;if(!$("#"+this.containerId).find(".flow_thumbnail").is(":hidden")){var e=$("#"+t.containerId).find(".canvas"),i=$("#"+t.containerId).find(".canvas").parent(),n=$("#"+t.containerId).find(".flow_thumbnail"),a=e.width(),s=e.height(),o=i.width(),r=i.height(),l=1*n.width()/a*1;$("#"+t.containerId).find(".flow_thumbnail").height(l*s);var d=o*l+"px",c=r*l+"px",h=i.scrollLeft()*l+"px",u=i.scrollTop()*l+"px";$("#"+t.containerId).find(".flow_thumbnail_mask").css("width",d),$("#"+t.containerId).find(".flow_thumbnail_mask").css("height",c),$("#"+t.containerId).find(".flow_thumbnail_mask").css("left",h),$("#"+t.containerId).find(".flow_thumbnail_mask").css("top",u),t._timer_thumbnail&&clearTimeout(t._timer_thumbnail),t._timer_thumbnail=setTimeout(function(){t.getSnapshot(function(e){try{var i=e.toDataURL("image/png");$("#"+t.containerId).find(".flow_thumbnail").css("background-image","url("+i+")")}catch(t){console.error(t)}},{scale:.5,backgroundColor:"transparent",ignore_svg:!0})},10)}},_resizeCanvas:function(){var t=0,e=0;$("#"+this.containerId).find(".canvas").find("div").each(function(i,n){let a=$(n).position().left,s=$(n).width(),o=$(n).position().top,r=$(n).height();a+s>t&&(t=a+s),o+r>e&&(e=o+r)}),$("#"+this.containerId).find(".canvas").width(t),$("#"+this.containerId).find(".canvas").height(e)},_onCanvasChanged:function(){var t=this;setTimeout(function(){t._showThumbnail(),t._resizeCanvas(),t.event_canvas_changed&&t.event_canvas_changed()},50)},_formateDateTime:function(t){if(0==t.indexOf("0001"))return"";var e=t,i=t.indexOf("+");return i>=0&&(e=e.substr(0,i)),(i=t.indexOf("."))>=0&&(e=e.substr(0,i)),(i=t.indexOf("Z"))>=0&&(e=e.substr(0,i)),e=e.replace("T"," ")},_isGroup:function(t){var e=this._plumb.getGroups();for(var i in e)if(e[i].id==t)return!0;return!1},_paintConnection:function(t,e){var i=this.flowModel.link_type||"Flowchart",n=e.source_id.indexOf("tip_")>=0||e.target_id.indexOf("tip_")>=0,a=this._isGroup(e.source_id)||this._isGroup(e.target_id),s=e.source_id.indexOf("list_")>=0||e.target_id.indexOf("list_")>=0,o=e.lineStyle||"solid",r=e.active||"true",l=e.paintStyle,d=e.hoverPaintStyle,c=l||{stroke:this._themeObj.default_link_color,radius:this._themeObj.default_link_radius,strokeWidth:this._themeObj.default_link_strokeWidth,outlineStroke:"transparent",outlineWidth:this._themeObj.default_link_outlineWidth},h=d||{stroke:this._themeObj.default_link_color_hover,radius:this._themeObj.default_link_radius_hover,strokeWidth:this._themeObj.default_link_strokeWidth_hover,outlineStroke:"transparent",outlineWidth:this._themeObj.default_link_outlineWidth_hover};"dotted"==o||null!=r&&"false"==r?(c.dashstyle="2 1",h.dashstyle="2 1"):(c.dashstyle="1 0",h.dashstyle="1 0"),n?(c.stroke=this._themeObj.default_link_color_t,c.radius=this._themeObj.default_link_radius_t,c.strokeWidth=this._themeObj.default_link_strokeWidth_t,c.outlineStroke="transparent",c.outlineWidth=this._themeObj.default_link_outlineWidth_t,h.stroke=this._themeObj.default_link_color_t_hover,h.radius=this._themeObj.default_link_radius_t_hover,h.strokeWidth=this._themeObj.default_link_strokeWidth_t_hover,h.outlineStroke="transparent",h.outlineWidth=this._themeObj.default_link_outlineWidth_t_hover,c.dashstyle="5 3",h.dashstyle="5 3"):a&&(c.stroke=this._themeObj.default_link_color_g,c.radius=this._themeObj.default_link_radius_g,c.strokeWidth=this._themeObj.default_link_strokeWidth_g,c.outlineStroke="transparent",c.outlineWidth=this._themeObj.default_link_outlineWidth_g,h.stroke=this._themeObj.default_link_color_g_hover,h.radius=this._themeObj.default_link_radius_g_hover,h.strokeWidth=this._themeObj.default_link_strokeWidth_g_hover,h.outlineStroke="transparent",h.outlineWidth=this._themeObj.default_link_outlineWidth_g_hover),t.setType(i),t.setPaintStyle(c),t.setHoverPaintStyle(h),t.getOverlay("arrow_source").setVisible(!1),t.getOverlay("arrow_middle").setVisible(!1),t.getOverlay("arrow_target").setVisible(!0),e.source_id.indexOf("list_")>=0&&(t.getOverlay("arrow_source").setVisible(!1),t.getOverlay("label_source").setVisible(!0)),e.target_id.indexOf("list_")>=0&&(t.getOverlay("arrow_target").setVisible(!1),t.getOverlay("label_target").setVisible(!0)),e.arrows&&e.arrows.length>0&&(e.arrows[0]?t.getOverlay("arrow_source").setVisible(!0):t.getOverlay("arrow_source").setVisible(!1),e.arrows.length>1&&e.arrows[1]?t.getOverlay("arrow_middle").setVisible(!0):t.getOverlay("arrow_middle").setVisible(!1),e.arrows.length>2&&e.arrows[2]?t.getOverlay("arrow_target").setVisible(!0):t.getOverlay("arrow_target").setVisible(!1)),t.getOverlay("animation").width=2*this._themeObj.default_link_strokeWidth_g,t.getOverlay("animation").length=2*this._themeObj.default_link_strokeWidth_g,t.getOverlay("animation").setVisible(!1);var u=$("<div/>").text(e.title||e.label||"").html();t.getOverlay("label").setVisible(u.length>0),t.getOverlay("label").setLabel(u);var _=$("<div/>").text(e.label_source||"").html();t.getOverlay("label_source").setVisible(_.length>0),t.getOverlay("label_source").setLabel(_);var f=$("<div/>").text(e.label_target||"").html();t.getOverlay("label_target").setVisible(f.length>0),t.getOverlay("label_target").setLabel(f),e.show_remove||s?t.getOverlay("label_remove").setVisible(!0):t.getOverlay("label_remove").setVisible(!1),n?(t.getOverlay("arrow_source").setVisible(!1),t.getOverlay("arrow_middle").setVisible(!1),t.getOverlay("arrow_target").setVisible(!1)):a&&(t.getOverlay("arrow_source").width=3*this._themeObj.default_link_strokeWidth_g,t.getOverlay("arrow_source").length=3*this._themeObj.default_link_strokeWidth_g,t.getOverlay("arrow_target").width=3*this._themeObj.default_link_strokeWidth_g,t.getOverlay("arrow_target").length=3*this._themeObj.default_link_strokeWidth_g,t.getOverlay("arrow_middle").width=3*this._themeObj.default_link_strokeWidth_g,t.getOverlay("arrow_middle").length=3*this._themeObj.default_link_strokeWidth_g),t.data=e,this.render_link&&this.render_link(t,i,e)},_paintConnectionState:function(t,e){-1==e||"error"==e?t.setPaintStyle({stroke:this._themeObj.default_link_color_error,radius:this._themeObj.default_link_radius_error,strokeWidth:this._themeObj.default_link_strokeWidth_error,outlineStroke:"transparent",outlineWidth:this._themeObj.default_link_outlineWidth_error}):1==e||"execute"==e?t.setPaintStyle({stroke:this._themeObj.default_link_color_run,radius:this._themeObj.default_link_radius_run,strokeWidth:this._themeObj.default_link_strokeWidth_run,outlineStroke:"transparent",outlineWidth:this._themeObj.default_link_outlineWidth_run}):2==e||"success"==e?t.setPaintStyle({stroke:this._themeObj.default_link_color_success,radius:this._themeObj.default_link_radius_success,strokeWidth:this._themeObj.default_link_strokeWidth_success,outlineStroke:"transparent",outlineWidth:this._themeObj.default_link_outlineWidth_success}):3==e||"reject"==e?t.setPaintStyle({stroke:this._themeObj.default_link_color_reject,radius:this._themeObj.default_link_radius_reject,strokeWidth:this._themeObj.default_link_strokeWidth_reject,outlineStroke:"transparent",outlineWidth:this._themeObj.default_link_outlineWidth_reject}):t.setPaintStyle({stroke:this._themeObj.default_link_color,radius:this._themeObj.default_link_radius,strokeWidth:this._themeObj.default_link_strokeWidth,outlineStroke:"transparent",outlineWidth:this._themeObj.default_link_outlineWidth})},newInstance:function(t,e){return this.containerId=t,$.extend(this,e),null==this.flowModel&&(this.flowModel={}),null==this.flowModel.theme&&(this.flowModel.theme="flow_theme_default"),null==this.flowModel.link_type&&(this.flowModel.link_type="Flowchart"),null==this._connectionTypes[this.flowModel.link_type]&&(this.flowModel.link_type="Flowchart"),this._initHtml(t),this._initMetadata(),this._initTheme(),this._initPlumb(),this._initEvents(),this._initAnimaction(),this},refresh:function(){this.flowModel=this.getFlow(),this._initTheme(),this._initPlumb(),this.showFlow(),this.setActionStates(),this.setLinkStates(),this.setActionContents()},repaint:function(){this._plumb&&this._plumb.repaintEverything()},setTheme:function(t){for(var e in this.flowModel.theme=t||this.flowModel.theme||"flow_theme_default",this._themeObj=flow_themes[this.flowModel.theme],flow_themes)$("#"+this.containerId).find(".andflow").removeClass(e);$("#"+this.containerId).find(".andflow").addClass(this.flowModel.theme),this._plumb&&this._plumb.repaintEverything()},registActionScript:function(t,e){this._actionScript[t]=e},getActionScript:function(t){return this._actionScript[t]},getMetadata:function(t){for(var e in this.metadata){var i=this.metadata[e];if(t==i.name)return i}return null},getMetadatas:function(){return this.metadata},getDict:function(t){if(null==t||""==t)return null;var e=this.getFlow().dict;for(var i in e){var n=e[i];if(n.name==t)return n.label}return null},getDicts:function(){return this.getFlow().dict},getActionInfo:function(t){return this._actionInfos[t]},setActionInfo:function(t){for(var e in this._actionInfos[t.id]=t,$("#"+this.containerId+" #"+t.id).find(".action-header").html(t.title||t.des||""),action_themes)$("#"+this.containerId+" #"+t.id).removeClass(e);$("#"+this.containerId+" #"+t.id).addClass(t.theme||"");var i=t.icon;null!=i&&i.length>0&&$("#"+this.containerId+" #"+t.id).find(".action-icon img").attr("src",this.img_path+i),t.content&&this.setActionContent(t.id,t.content.content,t.content.content_type),this._plumb.repaintEverything()},delActionInfo:function(t){this._actionInfos[t]=null},setActionParam:function(t,e,i){this._actionInfos&&this._actionInfos[t]&&(this._actionInfos[t].params||(this._actionInfos[t].params={}),this._actionInfos[t].params[e]=i)},getActionParam:function(t,e){return this._actionInfos&&this._actionInfos[t]&&this._actionInfos[t].params?this._actionInfos[t].params[e]:null},getGroupInfo:function(t){return this._groupInfos[t]},setGroupInfo:function(t){this._groupInfos[t.id]=t;var e=$("#"+this.containerId+" #"+t.id);e.find(".group-header").html(t.title),e.find(".group-body").html(t.des)},getGroupTitle:function(t){return this._groupInfos[t].title},setGroupTitle:function(t,e){var i=this._groupInfos[t];null!=i&&(i.title=e,this._groupInfos[i.id]=i,$("#"+this.containerId+" #"+i.id).find(".group-header").html(i.title))},getListInfo:function(t){return this._listInfos[t]},setListInfo:function(t){this._listInfos[t.id]=t,$("#"+this.containerId+" #"+t.id).find(".list-header").html(t.title)},getListTitle:function(t){return(this._listInfos[t]||{}).title},setListTitle:function(t,e){var i=this._listInfos[t];null!=i&&(i.title=e,this._listInfos[i.id]=i,$("#"+this.containerId+" #"+i.id).find(".list-header").html(i.title))},getListItems:function(t){return(this._listInfos[t]||{}).items},setListItems:function(t,e){var i=this._listInfos[t];null!=i&&(i.items=e,this._listInfos[t]=i,this._setListItems(t,e),this.refresh())},getTipInfo:function(t){return this._tipInfos[t]},setTipInfo:function(t){this._tipInfos[t.id]=t},getLinkInfo:function(t,e){return this._linkInfos[t+"-"+e]||{}},setLinkInfo:function(t){$.extend(this._linkInfos[t.source_id+"-"+t.target_id],t);var e=this.getConnection(t.source_id,t.target_id);null!=e&&(this._paintConnection(e,t),this._plumb.repaintEverything())},delLinkInfo:function(t,e){this._linkInfos[t+"-"+e]=null},setLinkTitle:function(t,e,i){var n=this._linkInfos[n.source_id+"-"+n.target_id]||{source_id:t,target_id:e};n.title=i,this.setLinkInfo(n)},getLinkTitle:function(t,e){return(this._linkInfos[t+"-"+e]||{}).title},setLinkLabel:function(t,e,i){this.setLinkTitle(t,e,i)},getLinkLabel:function(t,e){return this.sgtLinkTitle(t,e)},setLinkSourceLabel:function(t,e,i){var n=this._linkInfos[n.source_id+"-"+n.target_id]||{source_id:t,target_id:e};n.label_source=i,this.setLinkInfo(n)},getLinkSourceLabel:function(t,e){return(this._linkInfos[t+"-"+e]||{}).label_source},setLinkTargetLabel:function(t,e,i){var n=this._linkInfos[n.source_id+"-"+n.target_id]||{source_id:t,target_id:e};n.label_target=i,this.setLinkInfo(n)},getLinkTargetLabel:function(t,e){return(this._linkInfos[t+"-"+e]||{}).label_target},removeGroup:function(t){var e=this._plumb.getGroup(t),i=this._groupInfos[e.id].delete_all||!1;1!=i&&(i=!1),e.getEl(),this._plumb.removeGroup(e,i)},removeGroup:function(t,e){var i=this._plumb.getGroup(t),n=e||!1;1!=n&&(n=!1),i.getEl(),this._plumb.removeGroup(i,n)},removeList:function(t){var e=$("#"+this.containerId+" #"+t);this._plumb.remove(e),e.remove()},removeTip:function(t){var e=$("#"+this.containerId+" #"+t);this._plumb.remove(e),e.remove()},removeAction:function(t){var e=$("#"+this.containerId+" #canvas #"+t);if(null!=e){var i=this._plumb.getGroups();for(var n in i){var a=i[n].getMembers();for(var s in a)a[s].id==t&&i[n].remove(e.get(0),null,!0)}this._plumb.remove(e),$(e).remove();var o=this._actionInfos[t];this.delActionInfo(t),this._actionCharts[t]=null,null!=this._actionCharts[t]&&this._actionCharts[t].dispose(),this._actionContents[t]=null,this.event_action_remove&&this.event_action_remove(o),this._onCanvasChanged()}},removeLink:function(t,e){var i=this.getConnection(t,e);if(null!=i){if(this.delLinkInfo(t,e),this._plumb.deleteConnection(i),this._plumb.repaintEverything(),this.event_link_remove){var n=this._linkInfos[t+"-"+e];this.event_link_remove(n)}this._onCanvasChanged()}},removeLinkBySource:function(t){var e=this.getConnectionsBySource(t);for(var i in e){var n=e[i],a=n.targetId;if(this.delLinkInfo(t,a),this._plumb.deleteConnection(n),this._plumb.repaintEverything(),this.event_link_remove){var s=this._linkInfos[t+"-"+a];this.event_link_remove(s)}this._onCanvasChanged()}},removeLinkByTarget:function(t){var e=this.getConnectionsByTarget(t);for(var i in e){var n=e[i],a=n.sourceId;if(this.delLinkInfo(a,t),this._plumb.deleteConnection(n),this._plumb.repaintEverything(),this.event_link_remove){var s=this._linkInfos[a+"-"+t];this.event_link_remove(s)}this._onCanvasChanged()}},setEditable:function(t){this.editable=t,1==this.editable?$("#"+this.containerId+" .andflow").removeClass("state"):$("#"+this.containerId+" .andflow").addClass("state")},getEditable:function(){return this.editable},setFlow:function(t){this.flowModel=t},showFlow:function(t){var e=this;t&&(this.flowModel=t),this._actionInfos={},this._linkInfos={},this._groupInfos={},this._listInfos={},this._tipInfos={},this._actionContents={},this._actionCharts={},this._action_states=[],this._link_states=[],this._plumb.deleteEveryConnection(),$(".action").parent().each(function(t,i){e._plumb.remove(i),e._plumb.remove($(i).children()),$(i).remove()}),$(".group").each(function(t,i){e._plumb.remove(i),$(i).remove()}),$(".tip").each(function(t,i){e._plumb.remove(i),$(i).remove()}),$(".list-item").each(function(t,i){e._plumb.remove(i),$(i).remove()}),this._plumb.removeAllGroups(!0),$("#canvas").html("");var i=this.flowModel;if(i&&i.actions)for(var n in i.actions){var a=i.actions[n];this._createAction(a)}if(i&&i.tips)for(var n in i.tips){var s=i.tips[n];this._createTip(s)}if(i&&i.lists)for(var n in i.lists){var o=i.lists[n];this._createList(o)}if(i&&i.groups)for(var n in i.groups){var r=i.groups[n];this._createGroup(r)}if(i&&i.links){this.flowModel.link_type;for(var n in i.links){var l=i.links[n],d=this._plumb.connect({source:l.source_id,target:l.target_id});null!=d&&null!=d&&(this._paintConnection(d,l),this._linkInfos[l.source_id+"-"+l.target_id]=l)}}for(var n in i.actions){a=i.actions[n];var c=this._plumb.getEndpoints(a.id);for(var n in c){var h=c[n];h.setPaintStyle({stroke:this._themeObj.default_endpoint_stroke_color,fill:this._themeObj.default_endpoint_fill_color,radius:this._themeObj.default_endpoint_radius,strokeWidth:this._themeObj.default_endpoint_strokeWidth}),h.setHoverPaintStyle({stroke:this._themeObj.default_endpoint_stroke_color_hover,fill:this._themeObj.default_endpoint_fill_color_hover,radius:this._themeObj.default_endpoint_radius_hover,strokeWidth:this._themeObj.default_endpoint_strokeWidth_hover})}}this._plumb.repaintEverything()},getFlow:function(){var t=this.getActions(),e=this.getLinks(),i=this.getGroups(),n=this.getLists(),a=this.getTips();return this.flowModel.actions=t,this.flowModel.groups=i,this.flowModel.lists=n,this.flowModel.links=e,this.flowModel.tips=a,this.flowModel},clearActionState:function(){$("#"+this.containerId).find(".action").removeClass("error"),$("#"+this.containerId).find(".action").removeClass("execute"),$("#"+this.containerId).find(".action").removeClass("reject"),$("#"+this.containerId).find(".action").removeClass("success")},setActionSelected:function(t,e){null!=t&&""!=t&&0!=$("#"+t).length&&(e?$("#"+t).find(".action").addClass("selected"):$("#"+t).find(".action").removeClass("selected"))},setActionIcon:function(t,e){null!=e&&e.length>0&&$("#"+t).find(".action-icon img").attr("src",this.img_path+e)},setActionState:function(t,e){if(null!=t&&""!=t){var i=$("#"+this.containerId).find("#"+t);if(null==e||""==e||0==e)return i.removeClass("error"),i.removeClass("execute"),i.removeClass("reject"),void i.removeClass("success");-1==e||"error"==e?(i.removeClass("error"),i.removeClass("execute"),i.removeClass("reject"),i.removeClass("success"),i.hasClass("error")||i.addClass("error")):1==e||"execute"==e?i.hasClass("execute")||i.addClass("execute"):2==e||"success"==e?(i.removeClass("error"),i.removeClass("execute"),i.removeClass("reject"),i.removeClass("success"),i.hasClass("success")||i.addClass("success")):3!=e&&"reject"!=e||(i.removeClass("error"),i.removeClass("execute"),i.removeClass("reject"),i.removeClass("success"),i.hasClass("reject")||i.addClass("reject"))}},setActionStates:function(t){null!=t&&null!=t||(t=this._action_states),this._action_states=t;var e=$("#"+this.containerId).find(".action");e.removeClass("success"),e.removeClass("error"),e.removeClass("execute");var i={};for(var n in t){i[o=t[n].action_id]=t[n]}var a=this.getActions();for(var s in a){action=a[s];var o,r=i[o=action.id];if(null!=r){var l=r.state;r.is_error&&(l=-1),this.setActionState(o,l);var d=r.action_icon;this.setActionIcon(o,d);var c=r.content;this.showActionContent(c)}}},setLinkState(t,e,i){var n=this.getConnection(t,e);if(null!=n){var a=n.data;null!=a&&"false"==a.active||this._paintConnectionState(n,i)}},setLinkStates:function(t){for(var e in null!=t&&null!=t||(t=this._link_states),this._link_states=t,t){var i=t[e],n=i.source_action_id,a=i.target_action_id,s=i.state,o=i.is_error;1!=o&&1!=o&&"true"!=o||(s=-1),this.setLinkState(n,a,s)}this._plumb.repaintEverything()},setLinkType:function(t){this.flowModel.link_type=t,this.refresh()},getGroups:function(){var t=[],e=this._plumb.getGroups();for(var i in e){var n=e[i],a=n.id,s=$(n.getEl()),o=n.getMembers(),r=this._groupInfos[a];for(var l in r.members=[],o){let t=o[l].id;r.members.push(t)}if("auto"!=r.left){let t=s.css("left");r.left=t}if("auto"!=r.top){let t=s.css("top");r.top=t}if("auto"!=r.width){let t=s.css("width");r.width=t}if("auto"!=r.height){let t=s.css("height");r.height=t}t.push(r)}return t},getLists:function(){var t=this,e=[];return $("#"+t.containerId+" #canvas").find(".list").each(function(i,n){var a=$(n),s=a.attr("id"),o=t._listInfos[s]||{id:a.attr("id"),left:"",top:"",width:"",height:""};a.parent().hasClass("group-container")?(o.left=a.position().left+a.parent().position().left+"px",o.top=a.position().top+a.parent().position().top+"px"):(o.left=a.css("left"),o.top=a.css("top")),o.width=a.css("width"),o.height=a.css("height"),e.push(o)}),e},getTips:function(){var t=this,e=[];return $("#"+t.containerId+" #canvas").find(".tip").each(function(i,n){var a=$(n),s=a.attr("id"),o=t._tipInfos[s]||{id:a.attr("id"),left:"",top:"",width:"",height:""};a.parent().hasClass("group-container")?(o.left=a.position().left+a.parent().position().left+"px",o.top=a.position().top+a.parent().position().top+"px"):(o.left=a.css("left"),o.top=a.css("top")),o.width=a.css("width"),o.height=a.css("height"),e.push(o)}),e},getActions:function(){var t=this,e=[],i=$("#"+this.containerId+" #canvas");for(var n in i.find(".action").each(function(i,n){var a=$(n).parent(),s=$(n),o=a.attr("id"),r=t._actionInfos[o];null==r&&(r={});let l=a.parent().hasClass("group-container");r.id=o,r.name=s.attr("name"),r.title=s.attr("title"),r.icon=s.attr("icon"),r.des=s.attr("des"),l?(r.left=a.position().left+a.parent().position().left+"px",r.top=a.position().top+a.parent().position().top+"px"):(r.left=a.position().left+"px",r.top=a.position().top+"px"),r.width=a.css("width"),r.height=a.css("height"),r.body_width=a.attr("body_width"),r.body_height=a.attr("body_height"),e.push(r)}),e)e[n].id;return e},getLinks:function(){for(var t=[],e=this._plumb.getAllConnections(),i=0;i<e.length;i++){var n=e[i].sourceId,a=e[i].targetId,s=this._linkInfos[n+"-"+a];null==s&&(s={}),s.source_id=n,s.target_id=a,this._linkInfos[n+"-"+a]=s,t.push(s)}return t},getConnection:function(t,e){for(var i=this._plumb.getAllConnections(),n=0;n<i.length;n++){var a=i[n].sourceId,s=i[n].targetId;if(a==t&&s==e)return i[n]}return null},getConnectionsBySource:function(t){for(var e=this._plumb.getAllConnections(),i=[],n=0;n<e.length;n++){e[n].sourceId==t&&i.push(e[n])}return i},getConnectionsByTarget:function(t){for(var e=this._plumb.getAllConnections(),i=[],n=0;n<e.length;n++){e[n].targetId==t&&i.push(e[n])}return i},horizontal:function(){var t=999999999,e=this.getFlow();for(var i in e.actions){var n=e.actions[i].top;t>(n=n.replace(/px/gi,""))&&(t=n)}for(var i in t<10&&(t=10),e.actions)e.actions[i].top=t+"px";this.showFlow(e),this.setActionStates(this._action_states),this.setLinkStates(this._link_states)},vertical:function(){var t=999999999,e=this.getFlow();for(var i in e.actions){var n=e.actions[i].top;t>(n=n.replace(/px/gi,""))&&(t=n)}for(var i in t<10&&(t=10),e.actions)e.actions[i].left=t+"px";this.showFlow(e),this.setActionStates(this._action_states),this.setLinkStates(this._link_states)},getSnapshot:function(t,e){if($("#canvas").is(":hidden"))return;var i={backgroundColor:"white"};e&&$.extend(i,e);var n=document.querySelector("#canvas");if(i.ignore_svg){var a=[],s=[];$(n).find("svg").each(function(t,e){var i=e.parentNode,n=e.outerHTML.trim(),o=document.createElement("canvas");canvg(o,n),e.style.position&&(o.style.position=e.style.position,o.style.left=e.style.left,o.style.top=e.style.top),a.push({parent:i,child:e}),i.removeChild(e),s.push({parent:i,child:o}),i.appendChild(o)})}let o=document.createElement("canvas"),r=n.scrollWidth,l=n.scrollHeight,d=i.scale||1;o.width=r*d,o.height=l*d,o.style.width=r*d+"px",o.style.height=l*d+"px",$(o).css("position","relative"),$(o).css("box-sizing","border-box"),$(o).css("font-size","12px"),$(o).css("padding","0px"),html2canvas(n,{canvas:o,scale:d,dpi:96,backgroundColor:i.backgroundColor||"transparent",width:r,height:l,scrollY:0,scrollX:0,useCORS:!0}).then(function(e){for(var i in s){(n=s[i]).parent.removeChild(n.child)}for(var i in a){var n;(n=a[i]).parent.appendChild(n.child)}t&&t(e)}),$(o).remove()},snap:function(t){t=t||"andflow";this.getSnapshot(function(e){var i=e.toDataURL("image/jpeg");$("<a></a>").attr("href",i).attr("download",t+".jpg")[0].click()})},setActionContents:function(t){if(t&&(this._actionContents=t),null!=this._actionContents&&0!=this._actionContents.length)for(var e in this._actionContents){var i=this._actionContents[e];this.setActionContent(e,i.content,i.content_type)}},getActionTitle:function(t){return this._actionInfos[t].title},setActionTitle:function(t,e){this._actionInfos[t].title=e,$("#"+this.containerId+" #canvas").find("#"+t).find(".action-header").html(e)},setActionTheme:function(t,e){for(var i in this._actionInfos[t].theme=e,flow_themes)$("#"+this.containerId).find("#"+t).removeClass(i);$("#"+this.containerId).find("#"+t).addClass(e),this._plumb&&this._plumb.repaintEverything()},getActionContent:function(t){return this._actionContents[t]},setActionContent:function(t,e,i){if(this._actionInfos[t].content={content_type:i,content:e},this._actionContents[t]={content_type:i,content:e},0!=this.flowModel.show_action_content&&"false"!=this.flowModel.show_action_content){var n=$("#"+this.containerId).find("#"+t+" .action-content");switch(i){case"msg":null!=this._actionCharts[t]&&(this._actionCharts[t].dispose(),this._actionCharts[t]=null),n.html("<div class='action-msg'>"+e+"</div>");break;case"keyvalue":var a=JSON.parse(e),s=$('<table class="action-result-table" style="width:100%"></table>');for(var o in a)s.append('<tr><td class="action-result-label">'+o+'</td><td class="action-result-value">'+a[o]+"</td></tr>");n.html(""),n.append(s),n.css("overflow-y","auto");break;case"grid":null!=this._actionCharts[t]&&(this._actionCharts[t].dispose(),this._actionCharts[t]=null);var r=JSON.parse(e),l=r.columns,d=[];if((a=r.rows)instanceof Array?d=a:d.push(a),(null==l||0==l.length)&&(l=[],d.length>0))for(var o in d[0])l.push({name:o,title:o});s=$('<table class="table" style="width:100%"></table>');var c=$("<tr></tr>");for(var h in l){var u=l[h].title||l[h].name,_=$("<th>"+u+"</th>");c.append(_)}for(var f in s.append(c),d){var p=d[f],v=[];if(p instanceof Object)for(var o in l)v.push(p[l[o].name]);else v.push(p);var g=$("<tr></tr>");for(var h in v){var m=v[h];m instanceof Object&&(m=JSON.stringify(m));_=$("<td>"+m+"</td>");g.append(_)}s.append(g)}n.html(""),n.append(s),n.css("overflow-y","auto");break;case"html":null!=this._actionCharts[t]&&(this._actionCharts[t].dispose(),this._actionCharts[t]=null),n.html("<div class='action-html'>"+e+"</div>");break;case"chart":var b=JSON.parse(e),A="chart_"+t,k=n.find("#"+A),w=this._actionCharts[t];if(null==w||null==k||0==k.length){n.html("<div id='"+A+"' class='action-chart'></div>");var C=n.width(),I=n.height();$("#"+A).width(C),$("#"+A).height(I),w=echarts.init(document.getElementById(A))}w.setOption(b),this._actionCharts[t]=w;break;case"form":null!=this._actionCharts[t]&&(this._actionCharts[t].dispose(),this._actionCharts[t]=null);var y=(a=JSON.parse(e)).url;n.html('<iframe src="'+y+'" style="width:100%;height: 100%;" frameborder="0"></iframe>');break;case"web":null!=this._actionCharts[t]&&(this._actionCharts[t].dispose(),this._actionCharts[t]=null),n.html('<iframe src="'+e+'" style="width:100%;height: 100%;" frameborder="0"></iframe>');break;default:null!=this._actionCharts[t]&&(this._actionCharts[t].dispose(),this._actionCharts[t]=null),n.html(e)}}},showAllActionContent:function(t){if(t)for(var e in t){var i=t[e].content;null!=i&&this.showActionContent(i)}},showActionContent:function(t){if(null!=t&&null!=t.content_type&&null!=t.content){var e=t.content_type,i=t.content,n=t.action_id;this.setActionContent(n,i,e)}},setActionBodyVisible:function(t){this.flowModel.show_action_body=t?"true":"false","false"==this.flowModel.show_action_body?$("#"+this.containerId+" .action-body").hide():$("#"+this.containerId+" .action-body").show()},setActionContentVisible:function(t){this.flowModel.show_action_content=t?"true":"false","false"==this.flowModel.show_action_content||0==this.flowModel.show_action_content?$("#"+this.containerId+" .action-content").hide():$("#"+this.containerId+" .action-content").show()}};